<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å€’æ•¸è¨ˆæ™‚å™¨æ§åˆ¶é¢æ¿ - æŸ’æŸ’ chi</title>
    <link rel="icon" type="image/png" href="../images/é ­è²¼%20-%20åœ“å½¢.png" />
    <link rel="stylesheet" href="../style.css" />
    
    <!-- è¼‰å…¥å°èˆªæ¬„ -->
    <script src="../navbar.js"></script>
    
    <style>
      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        padding: 2rem;
        padding-top: calc(var(--navbar-height) + 2rem); /* ç‚ºå°èˆªæ¬„ç•™å‡ºç©ºé–“ */
      }

      .control-panel {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(125, 211, 252, 0.2);
        border-radius: 20px;
        padding: 2rem;
      }

      .panel-title {
        font-size: 2rem;
        font-weight: 900;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #7dd3fc, #c084fc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-align: center;
      }

      .panel-subtitle {
        text-align: center;
        color: #94a3b8;
        margin-bottom: 2rem;
      }

      .form-section {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(125, 211, 252, 0.1);
      }

      .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #7dd3fc;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: #e2e8f0;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(125, 211, 252, 0.2);
        border-radius: 8px;
        color: #fff;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: #7dd3fc;
        background: rgba(255, 255, 255, 0.08);
      }

      .form-checkbox-group {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .checkbox-item label {
        color: #e2e8f0;
        cursor: pointer;
      }

      .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
      }

      .btn {
        flex: 1;
        min-width: 200px;
        padding: 1rem 2rem;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: linear-gradient(135deg, #7dd3fc, #3b82f6);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(125, 211, 252, 0.4);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #c084fc, #9333ea);
        color: white;
      }

      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(192, 132, 252, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #34d399, #10b981);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(52, 211, 153, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, #f87171, #ef4444);
        color: white;
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(248, 113, 113, 0.4);
      }

      .help-text {
        font-size: 0.85rem;
        color: #94a3b8;
        margin-top: 0.25rem;
      }

      .current-time {
        background: rgba(125, 211, 252, 0.1);
        border-left: 4px solid #7dd3fc;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-family: 'Courier New', monospace;
      }

      .quick-preset {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }

      .preset-btn {
        padding: 0.5rem 1rem;
        background: rgba(125, 211, 252, 0.1);
        border: 1px solid rgba(125, 211, 252, 0.3);
        border-radius: 6px;
        color: #7dd3fc;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .preset-btn:hover {
        background: rgba(125, 211, 252, 0.2);
        border-color: #7dd3fc;
      }

      .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #34d399, #10b981);
        color: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(52, 211, 153, 0.4);
        font-weight: 700;
        z-index: 1000;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
      }

      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }

      @media (max-width: 768px) {
        .button-group {
          flex-direction: column;
        }

        .btn {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="control-panel">
      <h1 class="panel-title">â±ï¸ å€’æ•¸è¨ˆæ™‚å™¨æ§åˆ¶é¢æ¿</h1>
      <p class="panel-subtitle">è¼•é¬†è¨­å®šæ‚¨çš„åŠ ç­å°å€’æ•¸è¨ˆæ™‚å™¨</p>

      <div class="current-time" id="currentTime">
        â° ç¾åœ¨æ™‚é–“ï¼šè¼‰å…¥ä¸­...
      </div>

      <form id="countdownForm">
        <!-- æ™‚é–“è¨­å®š -->
        <div class="form-section">
          <h2 class="section-title">ğŸ• æ™‚é–“è¨­å®š</h2>
          
          <div class="form-group">
            <label class="form-label">è¦å€’æ•¸å¤šä¹…ï¼ˆåˆ†é˜ï¼‰</label>
            <input type="number" class="form-input" id="durationMinutes" min="1" value="180" />
            <div class="help-text">å¾ç¾åœ¨é–‹å§‹å€’æ•¸çš„æ™‚é–“é•·åº¦ï¼ˆé è¨­ 3 å°æ™‚ = 180 åˆ†é˜ï¼‰</div>
          </div>

          <div class="quick-preset">
            <button type="button" class="preset-btn" onclick="setDuration(30)">30 åˆ†é˜</button>
            <button type="button" class="preset-btn" onclick="setDuration(60)">1 å°æ™‚</button>
            <button type="button" class="preset-btn" onclick="setDuration(120)">2 å°æ™‚</button>
            <button type="button" class="preset-btn" onclick="setDuration(180)">3 å°æ™‚</button>
            <button type="button" class="preset-btn" onclick="setDuration(240)">4 å°æ™‚</button>
            <button type="button" class="preset-btn" onclick="setDuration(300)">5 å°æ™‚</button>
          </div>
        </div>

        <!-- é¡¯ç¤ºè¨­å®š -->
        <div class="form-section">
          <h2 class="section-title">ğŸ¨ é¡¯ç¤ºè¨­å®š</h2>
          
          <div class="form-group">
            <label class="form-label">æ¨™é¡Œ</label>
            <input type="text" class="form-input" id="title" value="åŠ ç­å°å€’æ•¸è¨ˆæ™‚" />
          </div>

          <div class="form-group">
            <label class="form-label">å€’æ•¸è¨Šæ¯</label>
            <input type="text" class="form-input" id="message" value="è·é›¢é–‹æ’­é‚„æœ‰" />
          </div>

          <div class="form-group">
            <label class="form-label">çµæŸè¨Šæ¯</label>
            <input type="text" class="form-input" id="endMessage" value="ğŸ‰ é–‹æ’­æ™‚é–“åˆ°ï¼" />
          </div>

          <div class="form-group">
            <label class="form-label">é¡¯ç¤ºå–®ä½</label>
            <div class="form-checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="showDays" checked />
                <label for="showDays">é¡¯ç¤ºå¤©æ•¸</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="showHours" checked />
                <label for="showHours">é¡¯ç¤ºå°æ™‚</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="showMinutes" checked />
                <label for="showMinutes">é¡¯ç¤ºåˆ†é˜</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="showSeconds" checked />
                <label for="showSeconds">é¡¯ç¤ºç§’æ•¸</label>
              </div>
            </div>
          </div>
        </div>

        <!-- æ‰‹å‹•å¢åŠ æ™‚é–“ -->
        <div class="form-section">
          <h2 class="section-title">âš¡ æ‰‹å‹•å¢åŠ æ™‚é–“</h2>
          <div class="help-text" style="margin-bottom: 1rem;">æ ¹æ“šåŠ ç­å°è¦å‰‡å¿«é€Ÿå¢åŠ å€’æ•¸æ™‚é–“</div>
          
          <div class="form-group">
            <label class="form-label">ğŸ“º è¨‚é–±åŠ æ™‚è¦å‰‡</label>
            <div class="quick-preset" style="margin-top: 0.5rem;">
              <button type="button" class="preset-btn" onclick="addTime(60)" style="background: rgba(147, 51, 234, 0.2); border-color: rgba(147, 51, 234, 0.5); color: #c084fc;">
                â­ å±¤ç´šä¸€è¨‚é–± +60åˆ†
              </button>
              <button type="button" class="preset-btn" onclick="addTime(140)" style="background: rgba(147, 51, 234, 0.2); border-color: rgba(147, 51, 234, 0.5); color: #c084fc;">
                â­â­ å±¤ç´šäºŒè¨‚é–± +140åˆ†
              </button>
              <button type="button" class="preset-btn" onclick="addTime(220)" style="background: rgba(147, 51, 234, 0.2); border-color: rgba(147, 51, 234, 0.5); color: #c084fc;">
                â­â­â­ å±¤ç´šä¸‰è¨‚é–± +220åˆ†
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ å…¶ä»–åŠ æ™‚æ–¹å¼</label>
            <div class="quick-preset" style="margin-top: 0.5rem;">
              <button type="button" class="preset-btn" onclick="addTime(30)" style="background: rgba(52, 211, 153, 0.2); border-color: rgba(52, 211, 153, 0.5); color: #34d399;">
                ğŸ’š æ–°è¿½éš¨è€… +30åˆ†
              </button>
              <button type="button" class="preset-btn" onclick="addSeconds(10)" style="background: rgba(251, 191, 36, 0.2); border-color: rgba(251, 191, 36, 0.5); color: #fbbf24;">
                âœ¨ å°å¥‡é» +10ç§’
              </button>
              <button type="button" class="preset-btn" onclick="addTime(2)" style="background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); color: #3b82f6;">
                ğŸ’° æ–—å…§ +2åˆ†/1å…ƒ
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">â±ï¸ è‡ªè¨‚å¢åŠ æ™‚é–“</label>
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
              <input type="number" class="form-input" id="customMinutes" placeholder="åˆ†é˜æ•¸" min="0" style="flex: 1; min-width: 150px;" />
              <button type="button" class="preset-btn" onclick="addCustomTime()">
                â• å¢åŠ æ™‚é–“
              </button>
              <input type="number" class="form-input" id="customSeconds" placeholder="ç§’æ•¸" min="0" style="flex: 1; min-width: 150px;" />
              <button type="button" class="preset-btn" onclick="addCustomSeconds()">
                â• å¢åŠ ç§’æ•¸
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ”§ æ™‚é–“èª¿æ•´</label>
            <div class="quick-preset" style="margin-top: 0.5rem;">
              <button type="button" class="preset-btn" onclick="addTime(5)" style="background: rgba(125, 211, 252, 0.2); border-color: rgba(125, 211, 252, 0.5); color: #7dd3fc;">
                +5åˆ†é˜
              </button>
              <button type="button" class="preset-btn" onclick="addTime(10)" style="background: rgba(125, 211, 252, 0.2); border-color: rgba(125, 211, 252, 0.5); color: #7dd3fc;">
                +10åˆ†é˜
              </button>
              <button type="button" class="preset-btn" onclick="addTime(-5)" style="background: rgba(248, 113, 113, 0.2); border-color: rgba(248, 113, 113, 0.5); color: #f87171;">
                -5åˆ†é˜
              </button>
              <button type="button" class="preset-btn" onclick="addTime(-10)" style="background: rgba(248, 113, 113, 0.2); border-color: rgba(248, 113, 113, 0.5); color: #f87171;">
                -10åˆ†é˜
              </button>
            </div>
          </div>
        </div>

        <!-- æŒ‰éˆ•ç¾¤çµ„ -->
        <div class="button-group">
          <button type="button" class="btn btn-primary" onclick="saveAndPreview()">
            ğŸ’¾ å„²å­˜ä¸¦é è¦½
          </button>
          <button type="button" class="btn btn-success" onclick="openCountdown()">
            ğŸš€ é–‹å•Ÿå€’æ•¸é é¢
          </button>
          <button type="button" class="btn btn-secondary" onclick="loadSettings()">
            ğŸ”„ è®€å–è¨­å®š
          </button>
          <button type="button" class="btn" onclick="pauseCountdown()" id="pauseBtn" style="background: rgba(251, 191, 36, 0.2); border-color: rgba(251, 191, 36, 0.5); color: #fbbf24;">
            â¸ï¸ æš«åœå€’æ•¸
          </button>
          <button type="button" class="btn" onclick="resumeCountdown()" id="resumeBtn" style="background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.5); color: #22c55e; display: none;">
            â–¶ï¸ ç¹¼çºŒå€’æ•¸
          </button>
          <button type="button" class="btn btn-danger" onclick="resetSettings()">
            ğŸ—‘ï¸ é‡ç½®è¨­å®š
          </button>
        </div>

        <div style="margin-top: 1rem; text-align: center;">
          <a href="/" style="color: #7dd3fc; text-decoration: none;">ğŸ  å›é¦–é </a>
        </div>
      </form>
    </div>

    <div class="notification" id="notification"></div>

    <script>
      // æ›´æ–°ç•¶å‰æ™‚é–“é¡¯ç¤º
      function updateCurrentTime() {
        const now = new Date();
        const timeStr = now.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        document.getElementById('currentTime').textContent = `â° ç¾åœ¨æ™‚é–“ï¼š${timeStr}`;
      }
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);

      // è¨­å®šå€’æ•¸æ™‚é•·
      function setDuration(minutes) {
        document.getElementById('durationMinutes').value = minutes;
      }

      // å¢åŠ æ™‚é–“ï¼ˆåˆ†é˜ï¼‰
      async function addTime(minutes) {
        // å„ªå…ˆå¾ä¼ºæœå™¨è¼‰å…¥ç•¶å‰è¨­å®š
        let config = null;
        try {
          const response = await fetch('get-countdown.php?t=' + Date.now(), { cache: 'no-cache' });
          const result = await response.json();
          if (result.success && result.data) {
            config = result.data;
            console.log('â˜ï¸ å¾ä¼ºæœå™¨è¼‰å…¥è¨­å®šç”¨æ–¼åŠ æ™‚:', config);
          }
        } catch (e) {
          console.error('âŒ ç„¡æ³•å¾ä¼ºæœå™¨è¼‰å…¥è¨­å®š:', e);
        }

        // å¦‚æœä¼ºæœå™¨è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦ localStorage
        if (!config) {
          const saved = localStorage.getItem('countdownConfig');
          if (saved) {
            config = JSON.parse(saved);
            console.log('ğŸ’¾ ä½¿ç”¨ localStorage è¨­å®šç”¨æ–¼åŠ æ™‚');
          }
        }

        if (!config) {
          showNotification('âš ï¸ è«‹å…ˆè¨­å®šä¸¦å„²å­˜å€’æ•¸æ™‚é–“ï¼', 'warning');
          return;
        }

        try {
          // è¨ˆç®—æ–°çš„ç›®æ¨™æ™‚é–“
          let currentTarget;
          if (config.isPaused && config.remainingMs) {
            // å¦‚æœæ˜¯æš«åœç‹€æ…‹ï¼Œä½¿ç”¨ remainingMs
            currentTarget = Date.now() + config.remainingMs;
          } else if (config.targetTimestamp) {
            currentTarget = config.targetTimestamp;
          } else if (config.targetDate) {
            currentTarget = new Date(config.targetDate).getTime();
          } else if (config.secondsFromNow) {
            // å¦‚æœæ˜¯å€’æ•¸æ™‚é•·æ¨¡å¼ï¼Œéœ€è¦è½‰æ›æˆçµ•å°æ™‚é–“
            currentTarget = Date.now() + (config.secondsFromNow * 1000);
          } else {
            showNotification('âš ï¸ ç„¡æ³•è®€å–ç›®æ¨™æ™‚é–“ï¼', 'error');
            return;
          }

          // å¢åŠ æ™‚é–“ï¼ˆç›´æ¥ä½¿ç”¨æ™‚é–“æˆ³è¨˜ï¼‰
          const newTargetTimestamp = currentTarget + (minutes * 60 * 1000);
          
          console.log('â• å¢åŠ æ™‚é–“:', minutes, 'åˆ†é˜');
          console.log('   æ–°ç›®æ¨™æ™‚é–“:', new Date(newTargetTimestamp).toLocaleString('zh-TW'));
          
          // æ›´æ–°è¨­å®š
          config.mode = 'timestamp';
          config.targetTimestamp = newTargetTimestamp;
          
          // å¦‚æœæ˜¯æš«åœç‹€æ…‹ï¼Œéœ€è¦æ›´æ–° remainingMs
          if (config.isPaused) {
            config.remainingMs = newTargetTimestamp - Date.now();
            console.log('â¸ï¸ æ›´æ–°æš«åœå‰©é¤˜æ™‚é–“:', config.remainingMs, 'ms');
          }
          
          delete config.targetDate;
          delete config.secondsFromNow;
          
          // å„²å­˜åˆ° localStorage
          localStorage.setItem('countdownConfig', JSON.stringify(config));
          
          // åŒæ­¥åˆ°ä¼ºæœå™¨
          saveToServer(config);
          
          const msg = minutes > 0 ? `+${minutes}` : minutes;
          showNotification(`âœ… å·²å¢åŠ  ${msg} åˆ†é˜ï¼`);
        } catch (e) {
          showNotification('âŒ å¢åŠ æ™‚é–“å¤±æ•—ï¼', 'error');
          console.error(e);
        }
      }

      // å¢åŠ æ™‚é–“ï¼ˆç§’ï¼‰
      function addSeconds(seconds) {
        const saved = localStorage.getItem('countdownConfig');
        if (!saved) {
          showNotification('âš ï¸ è«‹å…ˆè¨­å®šä¸¦å„²å­˜å€’æ•¸æ™‚é–“ï¼', 'warning');
          return;
        }

        try {
          const config = JSON.parse(saved);
          
          // è¨ˆç®—æ–°çš„ç›®æ¨™æ™‚é–“
          let currentTarget;
          if (config.targetTimestamp) {
            currentTarget = config.targetTimestamp;
          } else if (config.targetDate) {
            currentTarget = new Date(config.targetDate).getTime();
          } else if (config.secondsFromNow) {
            currentTarget = Date.now() + (config.secondsFromNow * 1000);
          } else {
            showNotification('âŒ æ‰¾ä¸åˆ°ç›®æ¨™æ™‚é–“ï¼', 'error');
            return;
          }

          // å¢åŠ æ™‚é–“ï¼ˆç›´æ¥ä½¿ç”¨æ™‚é–“æˆ³è¨˜ï¼‰
          const newTargetTimestamp = currentTarget + (seconds * 1000);
          
          console.log('â• å¢åŠ æ™‚é–“:', seconds, 'ç§’');
          console.log('   æ–°ç›®æ¨™æ™‚é–“:', new Date(newTargetTimestamp).toLocaleString('zh-TW'));
          
          // æ›´æ–°è¨­å®š
          config.mode = 'timestamp';
          config.targetTimestamp = newTargetTimestamp;
          delete config.targetDate;
          delete config.secondsFromNow;
          
          // å„²å­˜
          localStorage.setItem('countdownConfig', JSON.stringify(config));
          
          // åŒæ­¥åˆ°ä¼ºæœå™¨
          saveToServer(config);
          
          showNotification(`âœ… å·²å¢åŠ  ${seconds} ç§’ï¼`);
        } catch (e) {
          showNotification('âŒ å¢åŠ æ™‚é–“å¤±æ•—ï¼', 'error');
          console.error(e);
        }
      }

      // è‡ªè¨‚å¢åŠ æ™‚é–“ï¼ˆåˆ†é˜ï¼‰
      function addCustomTime() {
        const minutes = parseInt(document.getElementById('customMinutes').value);
        if (!minutes || isNaN(minutes)) {
          showNotification('âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„åˆ†é˜æ•¸ï¼', 'warning');
          return;
        }
        addTime(minutes);
        document.getElementById('customMinutes').value = '';
      }

      // è‡ªè¨‚å¢åŠ æ™‚é–“ï¼ˆç§’ï¼‰
      function addCustomSeconds() {
        const seconds = parseInt(document.getElementById('customSeconds').value);
        if (!seconds || isNaN(seconds)) {
          showNotification('âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„ç§’æ•¸ï¼', 'warning');
          return;
        }
        addSeconds(seconds);
        document.getElementById('customSeconds').value = '';
      }

      // å„²å­˜è¨­å®šåˆ°ä¼ºæœå™¨
      async function saveToServer(config) {
        try {
          const response = await fetch('/save-countdown', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(config),
            cache: 'no-cache'
          });
          
          const result = await response.json();
          if (result.success) {
            console.log('â˜ï¸ å·²åŒæ­¥åˆ°ä¼ºæœå™¨');
            return true;
          } else {
            console.error('âŒ åŒæ­¥åˆ°ä¼ºæœå™¨å¤±æ•—:', result.error);
            return false;
          }
        } catch (e) {
          console.error('âŒ ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨:', e);
          return false;

      // å„²å­˜è¨­å®š
      async function saveSettings() {
        const minutes = parseInt(document.getElementById('durationMinutes').value);
        if (!minutes || minutes < 1) {
          showNotification('è«‹è¨­å®šæœ‰æ•ˆçš„å€’æ•¸æ™‚é•·ï¼', 'error');
          return false;
        }
        // é è¨­å„²å­˜æ™‚ï¼Œè‹¥ç›®å‰æ˜¯æš«åœç‹€æ…‹ï¼Œå‰‡æ›´æ–° remainingMs
        let config = null;
        const saved = localStorage.getItem('countdownConfig');
        if (saved) {
          config = JSON.parse(saved);
          if (config.isPaused) {
            config.remainingMs = minutes * 60 * 1000;
            localStorage.setItem('countdownConfig', JSON.stringify(config));
            const serverSaved = await saveToServer(config);
            if (serverSaved) {
              showNotification('âœ… å·²æ›´æ–°æš«åœç‹€æ…‹çš„å‰©é¤˜æ™‚é–“ï¼');
            } else {
              showNotification('âŒ æ›´æ–°åˆ°ä¼ºæœå™¨å¤±æ•—ï¼Œä½†å·²å„²å­˜åˆ°æœ¬åœ°', 'error');
            }
            return serverSaved;
          }
        }
        
        // è¨ˆç®—ç›®æ¨™æ™‚é–“
        const targetTimestamp = Date.now() + (minutes * 60 * 1000);
        config = {
          mode: 'timestamp',
          targetTimestamp: targetTimestamp,
          title: document.getElementById('title').value || 'åŠ ç­å°å€’æ•¸è¨ˆæ™‚',
          message: document.getElementById('message').value || 'è·é›¢ä¸‹ç­é‚„æœ‰',
          endMessage: document.getElementById('endMessage').value || 'ğŸ‰ ä¸‹ç­å›‰ï¼',
          showDays: document.getElementById('showDays').checked,
          showHours: document.getElementById('showHours').checked,
          showMinutes: document.getElementById('showMinutes').checked,
          showSeconds: document.getElementById('showSeconds').checked,
          isPaused: true,
          remainingMs: minutes * 60 * 1000
        };
        localStorage.setItem('countdownConfig', JSON.stringify(config));
        
        const serverSaved = await saveToServer(config);
        if (serverSaved) {
          showNotification('âœ… è¨­å®šå·²å„²å­˜ï¼');
        } else {
          showNotification('âŒ å„²å­˜åˆ°ä¼ºæœå™¨å¤±æ•—ï¼Œä½†å·²å„²å­˜åˆ°æœ¬åœ°', 'error');
        }
        return serverSaved;
      }

      // è¼‰å…¥è¨­å®š
      function loadSettings() {
        const saved = localStorage.getItem('countdownConfig');
        if (saved) {
          const config = JSON.parse(saved);
          
          // å¦‚æœæœ‰ç›®æ¨™æ™‚é–“ï¼Œè¨ˆç®—å‰©é¤˜åˆ†é˜æ•¸
          let targetTime;
          if (config.targetTimestamp) {
            targetTime = config.targetTimestamp;
          } else if (config.targetDate) {
            targetTime = new Date(config.targetDate).getTime();
          }
          
          if (targetTime) {
            const now = Date.now();
            const remainingMinutes = Math.max(0, Math.ceil((targetTime - now) / 60000));
            document.getElementById('durationMinutes').value = remainingMinutes;
          }
          
          document.getElementById('title').value = config.title || 'åŠ ç­å°å€’æ•¸è¨ˆæ™‚';
          document.getElementById('message').value = config.message || 'è·é›¢é–‹æ’­é‚„æœ‰';
          document.getElementById('endMessage').value = config.endMessage || 'ğŸ‰ é–‹æ’­æ™‚é–“åˆ°ï¼';
          
          document.getElementById('showDays').checked = config.showDays !== false;
          document.getElementById('showHours').checked = config.showHours !== false;
          document.getElementById('showMinutes').checked = config.showMinutes !== false;
          document.getElementById('showSeconds').checked = config.showSeconds !== false;
          
          showNotification('âœ… è¨­å®šå·²è¼‰å…¥ï¼');
        } else {
          showNotification('âš ï¸ æ²’æœ‰æ‰¾åˆ°å„²å­˜çš„è¨­å®š', 'warning');
        }
      }

      // å„²å­˜ä¸¦é è¦½
      async function saveAndPreview() {
        const saved = await saveSettings();
        if (saved) {
          setTimeout(() => {
            window.open('countdown.html', '_blank');
          }, 500);
        }
      }

      // é–‹å•Ÿå€’æ•¸é é¢
      async function openCountdown() {
        // å…ˆå„²å­˜è¨­å®š
        const minutes = parseInt(document.getElementById('durationMinutes').value) || 180;
        console.log('ğŸš€ æº–å‚™é–‹å•Ÿå€’æ•¸é é¢ï¼Œå€’æ•¸æ™‚é•·:', minutes, 'åˆ†é˜');
        
        const saved = await saveSettings();
        if (saved) {
          console.log('âœ… è¨­å®šå·²å„²å­˜ï¼Œå³å°‡é–‹å•Ÿå€’æ•¸é é¢');
          setTimeout(() => {
            window.open('countdown.html?minutes=' + minutes, '_blank');
          }, 300);
        } else {
          console.error('âŒ å„²å­˜è¨­å®šå¤±æ•—');
          showNotification('âŒ å„²å­˜è¨­å®šå¤±æ•—', 'error');
        }
      }

      // é‡ç½®è¨­å®š
      function resetSettings() {
        if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨­å®šå—ï¼Ÿ')) {
          localStorage.removeItem('countdownConfig');
          
          document.getElementById('durationMinutes').value = 180;
          document.getElementById('title').value = 'åŠ ç­å°å€’æ•¸è¨ˆæ™‚';
          document.getElementById('message').value = 'è·é›¢é–‹æ’­é‚„æœ‰';
          document.getElementById('endMessage').value = 'ğŸ‰ é–‹æ’­æ™‚é–“åˆ°ï¼';
          document.getElementById('showDays').checked = true;
          document.getElementById('showHours').checked = true;
          document.getElementById('showMinutes').checked = true;
          document.getElementById('showSeconds').checked = true;
          
          showNotification('âœ… è¨­å®šå·²é‡ç½®ï¼');
        }
      }

      // é¡¯ç¤ºé€šçŸ¥
      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        
        if (type === 'error') {
          notification.style.background = 'linear-gradient(135deg, #f87171, #ef4444)';
        } else if (type === 'warning') {
          notification.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
        } else {
          notification.style.background = 'linear-gradient(135deg, #34d399, #10b981)';
        }
        
        notification.classList.add('show');
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }

      // æš«åœå€’æ•¸
      async function pauseCountdown() {
        const saved = localStorage.getItem('countdownConfig');
        if (!saved) {
          showNotification('âš ï¸ æ²’æœ‰æ­£åœ¨é€²è¡Œçš„å€’æ•¸ï¼', 'warning');
          return;
        }
        try {
          const config = JSON.parse(saved);
          // è¨ˆç®—å‰©é¤˜æ™‚é–“
          let remainingMs;
          if (config.targetTimestamp) {
            remainingMs = config.targetTimestamp - Date.now();
          } else if (config.targetDate) {
            remainingMs = new Date(config.targetDate).getTime() - Date.now();
          } else if (config.remainingMs) {
            remainingMs = config.remainingMs;
          } else {
            showNotification('âš ï¸ ç„¡æ³•å–å¾—ç›®æ¨™æ™‚é–“ï¼', 'error');
            return;
          }
          if (remainingMs <= 0) {
            showNotification('âš ï¸ å€’æ•¸å·²çµæŸï¼', 'warning');
            return;
          }
          // æ¨™è¨˜ç‚ºæš«åœç‹€æ…‹ï¼Œå„²å­˜å‰©é¤˜æ™‚é–“
          config.isPaused = true;
          config.remainingMs = remainingMs;
          delete config.targetTimestamp;
          delete config.targetDate;

          localStorage.setItem('countdownConfig', JSON.stringify(config));
          const serverSaved = await saveToServer(config);
          if (serverSaved) {
            // åˆ‡æ›æŒ‰éˆ•é¡¯ç¤º
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('resumeBtn').style.display = 'inline-block';
            showNotification('â¸ï¸ å€’æ•¸å·²æš«åœï¼');
            console.log('â¸ï¸ æš«åœå€’æ•¸ï¼Œå‰©é¤˜æ™‚é–“:', Math.floor(remainingMs / 60000), 'åˆ†é˜');
          } else {
            showNotification('âŒ æš«åœè¨­å®šå„²å­˜å¤±æ•—', 'error');
          }
        } catch (e) {
          showNotification('âŒ æš«åœå¤±æ•—ï¼', 'error');
          console.error(e);
        }
      }

      // ç¹¼çºŒå€’æ•¸
      async function resumeCountdown() {
        const saved = localStorage.getItem('countdownConfig');
        if (!saved) {
          showNotification('âš ï¸ æ²’æœ‰æš«åœçš„å€’æ•¸ï¼', 'warning');
          return;
        }
        try {
          const config = JSON.parse(saved);
          if (!config.isPaused || !config.remainingMs) {
            showNotification('âš ï¸ å€’æ•¸æœªæš«åœï¼', 'warning');
            return;
          }
          // å¾å‰©é¤˜æ™‚é–“é‡æ–°è¨ˆç®—ç›®æ¨™æ™‚é–“
          const targetTimestamp = Date.now() + config.remainingMs;
          config.targetTimestamp = targetTimestamp;
          config.isPaused = false;
          delete config.remainingMs;
          localStorage.setItem('countdownConfig', JSON.stringify(config));
          const serverSaved = await saveToServer(config);
          if (serverSaved) {
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('resumeBtn').style.display = 'none';
            showNotification('â–¶ï¸ å€’æ•¸å·²ç¹¼çºŒï¼');
            console.log('â–¶ï¸ ç¹¼çºŒå€’æ•¸ï¼Œç›®æ¨™æ™‚é–“:', new Date(targetTimestamp).toLocaleString('zh-TW'));
          } else {
            showNotification('âŒ ç¹¼çºŒè¨­å®šå„²å­˜å¤±æ•—', 'error');
          }
        } catch (e) {
          showNotification('âŒ ç¹¼çºŒå¤±æ•—ï¼', 'error');
          console.error(e);
        }
      }

      // æª¢æŸ¥æš«åœç‹€æ…‹
      function checkPauseState() {
        const saved = localStorage.getItem('countdownConfig');
        if (saved) {
          try {
            const config = JSON.parse(saved);
            if (config.isPaused) {
              document.getElementById('pauseBtn').style.display = 'none';
              document.getElementById('resumeBtn').style.display = 'inline-block';
            } else {
              document.getElementById('pauseBtn').style.display = 'inline-block';
              document.getElementById('resumeBtn').style.display = 'none';
            }
          } catch (e) {
            console.error('æª¢æŸ¥æš«åœç‹€æ…‹å¤±æ•—', e);
          }
        }
      }

      // åˆå§‹åŒ–ï¼šè¨­å®šé è¨­å€¼
      window.addEventListener('load', function() {
        checkPauseState();
        
        const saved = localStorage.getItem('countdownConfig');
        if (saved) {
          loadSettings();
        } else {
          // é è¨­ç‚º 3 å°æ™‚ï¼ˆ180 åˆ†é˜ï¼‰ï¼Œä½†é è¨­ç‹€æ…‹ç‚ºæš«åœ
          document.getElementById('durationMinutes').value = 180;
          // ç«‹å³å­˜ä¸€å€‹æš«åœç‹€æ…‹çš„ config
          const config = {
            mode: 'timestamp',
            isPaused: true,
            remainingMs: 180 * 60 * 1000,
            title: 'åŠ ç­å°å€’æ•¸è¨ˆæ™‚',
            message: 'è·é›¢ä¸‹ç­é‚„æœ‰',
            endMessage: 'ğŸ‰ ä¸‹ç­å›‰ï¼',
            showDays: true,
            showHours: true,
            showMinutes: true,
            showSeconds: true
          };
          localStorage.setItem('countdownConfig', JSON.stringify(config));
          saveToServer(config);
          checkPauseState();
        }
      });
    </script>
  </body>
</html>