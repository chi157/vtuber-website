<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ÂÄíÊï∏Ë®àÊôÇÂô® - ÊüíÊüí chi</title>
    <link rel="icon" type="image/png" href="../images/È†≠Ë≤º%20-%20ÂúìÂΩ¢.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- ËºâÂÖ•Ê®£ÂºèÂíåÂ∞éËà™Ê¨Ñ -->
    <link rel="stylesheet" href="../style.css" />
    <script src="../navbar.js"></script>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family);
        background: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        padding-top: calc(var(--navbar-height) + 20px); /* ÁÇ∫Â∞éËà™Ê¨ÑÁïôÂá∫Á©∫Èñì */
        background-image: 
          radial-gradient(circle at 20% 50%, rgba(125, 211, 252, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(192, 132, 252, 0.1) 0%, transparent 50%);
      }

      .countdown-container {
        text-align: center;
        max-width: 1400px;
        width: 100%;
      }

      .countdown-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 3rem;
        width: 100%;
      }

      .side-image {
        object-fit: contain;
        flex-shrink: 0;
        max-width: 200px;
      }

      .side-image.left {
        animation: floatLeft 3s ease-in-out infinite;
      }

      .side-image.right {
        animation: floatRight 3s ease-in-out infinite;
      }

      @keyframes floatLeft {
        0%, 100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      @keyframes floatRight {
        0%, 100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .countdown-title {
        font-size: 2.5rem;
        font-weight: 900;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .countdown-message {
        font-size: 1.5rem;
        margin-bottom: 3rem;
        opacity: 0.9;
      }

      .countdown-display {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: nowrap;
        margin-bottom: 3rem;
      }

      .time-unit {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(125, 211, 252, 0.2);
        border-radius: 20px;
        padding: 2rem 1.5rem;
        min-width: 140px;
        transition: all 0.3s ease;
      }

      .time-unit:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
        box-shadow: 0 10px 30px rgba(125, 211, 252, 0.3);
      }

      .time-value {
        font-size: 4rem;
        font-weight: 900;
        line-height: 1;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
      }

      .time-label {
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        opacity: 0.7;
      }

      .end-message {
        font-size: 3rem;
        font-weight: 900;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.9;
        }
      }

      .back-button {
        margin-top: 2rem;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        display: inline-block;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
      }

      .back-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(125, 211, 252, 0.4);
      }

      .add-time-animation {
        position: absolute;
        color: #7dd3fc;
        font-size: 2rem;
        font-weight: bold;
        pointer-events: none;
        animation: addTimeAnim 2s ease-out forwards;
        z-index: 10;
      }

      @keyframes addTimeAnim {
        0% { transform: translateY(-50px); opacity: 0; }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { transform: translateY(0); opacity: 0; }
      }
    </style>
  </head>
  <body>
    <div class="countdown-container">
      <h1 class="countdown-title" id="title">ÂÄíÊï∏Ë®àÊôÇÂô®</h1>
      <p class="countdown-message" id="message">ËºâÂÖ•‰∏≠...</p>
      
      <div class="countdown-wrapper">
        <img src="../images/Ë≤ìÈ†≠È∑πÈ£õËµ∑‰æÜ.png" alt="Ë≤ìÈ†≠È∑π" class="side-image left" id="leftImage">
        
        <div class="countdown-display" id="countdownDisplay">
          <!-- ÂÄíÊï∏Ë®àÊôÇÂô®ÊúÉÂú®ÈÄôË£°È°ØÁ§∫ -->
        </div>
        
        <img src="../images/‰∫∫È£õËµ∑‰æÜ.png" alt="‰∫∫Áâ©" class="side-image right" id="rightImage">
      </div>
      
    </div>

    <!-- ËºâÂÖ•Ë®≠ÂÆöÊ™î -->
    <script src="countdown-config.js"></script>
    
    <!-- ÂÄíÊï∏Ë®àÊôÇÂô®ÈÇèËºØ -->
    <script>
      let currentInterval = null;
      let targetTime = null;
      let config = null;
      let lastServerSync = 0;
      let lastDays = null, lastHours = null, lastMinutes = null, lastSeconds = null;
      let lastRemainingMs = null;
      
      // Âæû‰º∫ÊúçÂô®ËºâÂÖ•Ë®≠ÂÆö
      async function loadFromServer() {
        try {
          const response = await fetch('/get-countdown?t=' + Date.now(), { cache: 'no-cache' });
          const result = await response.json();
          
          if (result.success && result.data) {
            console.log('‚òÅÔ∏è Âæû‰º∫ÊúçÂô®ËºâÂÖ•Ë®≠ÂÆö:', result.data);
            return result.data;
          }
        } catch (e) {
          console.error('‚ùå ÁÑ°Ê≥ïÂæû‰º∫ÊúçÂô®ËºâÂÖ•:', e);
        }
        return null;
      }
      
      // ËºâÂÖ•‰∏¶ÊáâÁî®Ë®≠ÂÆö
      async function loadAndApplyConfig() {
        // ÂÖàÊ™¢Êü• URL ÂèÉÊï∏
        const urlParams = new URLSearchParams(window.location.search);
        const minutesParam = urlParams.get('minutes');
        if (minutesParam) {
          // Â¶ÇÊûú URL ÊúâÊåáÂÆöÂàÜÈêòÊï∏ÔºåÂÑ™ÂÖà‰ΩøÁî®
          const minutes = parseInt(minutesParam);
          if (minutes > 0) {
            config = {
              ...countdownConfig,
              targetTimestamp: Date.now() + (minutes * 60 * 1000),
              isPaused: false
            };
            console.log(`üåê ‰ΩøÁî® URL ÂèÉÊï∏: ${minutes} ÂàÜÈêò`);
            applyConfigStyles();
            return config;
          }
        }
        
        // ÂÑ™ÂÖàÂæû‰º∫ÊúçÂô®ËºâÂÖ•
        const serverConfig = await loadFromServer();
        if (serverConfig) {
          config = {
            ...countdownConfig,
            ...serverConfig,
            theme: countdownConfig.theme
          };
          console.log('‚úÖ Â∑≤ËºâÂÖ•‰º∫ÊúçÂô®Ë®≠ÂÆö');
          applyConfigStyles();
          return config;
        }
        
        // ÂÇôÁî®ÔºöËÆÄÂèñ localStorage
        const savedConfig = localStorage.getItem('countdownConfig');
        
        if (savedConfig) {
          try {
            const userConfig = JSON.parse(savedConfig);
            // Âêà‰ΩµË®≠ÂÆöÔºö‰ΩøÁî®ËÄÖË®≠ÂÆöÂÑ™ÂÖàÔºå‰ΩÜ‰øùÁïô‰∏ªÈ°åË®≠ÂÆö
            config = {
              ...countdownConfig,
              ...userConfig,
              theme: countdownConfig.theme // ‰øùÁïô‰∏ªÈ°åË®≠ÂÆö
            };
            console.log('‚úÖ Â∑≤ËºâÂÖ•ÊéßÂà∂Èù¢ÊùøË®≠ÂÆö', config);
          } catch (e) {
            console.error('ËºâÂÖ•Ë®≠ÂÆöÂ§±ÊïóÔºå‰ΩøÁî®È†êË®≠Ë®≠ÂÆö', e);
            config = countdownConfig;
          }
        } else {
          // Ê≤íÊúâÂÑ≤Â≠òÁöÑË®≠ÂÆöÔºåÈ†êË®≠ÁÇ∫Êö´ÂÅú‰∏âÂ∞èÊôÇ
          config = {
            ...countdownConfig,
            isPaused: true,
            remainingMs: 180 * 60 * 1000
          };
          console.log('‚ö†Ô∏è Ê≤íÊúâÂÑ≤Â≠òÁöÑË®≠ÂÆöÔºåÈ†êË®≠Êö´ÂÅú‰∏âÂ∞èÊôÇ', config);
        }

        applyConfigStyles();
        return config;
      }
      
      // ÊáâÁî®Ê®£ÂºèË®≠ÂÆö
      function applyConfigStyles() {
        // Ë®≠ÂÆö CSS ËÆäÊï∏
        document.documentElement.style.setProperty('--bg-color', config.theme.backgroundColor);
        document.documentElement.style.setProperty('--primary-color', config.theme.primaryColor);
        document.documentElement.style.setProperty('--secondary-color', config.theme.secondaryColor);
        document.documentElement.style.setProperty('--text-color', config.theme.textColor);
        document.documentElement.style.setProperty('--font-family', config.theme.fontFamily);

        // Ë®≠ÂÆöÊ®ôÈ°åÂíåË®äÊÅØ
        document.getElementById('title').textContent = config.title;
        document.getElementById('message').textContent = config.message;

        // Ë®àÁÆóÁõÆÊ®ôÊôÇÈñìÔºà‰ΩøÁî®ÊôÇÈñìÊà≥Ë®òÔºâ
        if (config.targetTimestamp) {
          targetTime = config.targetTimestamp;
          console.log('üéØ Ë®≠ÂÆöÁõÆÊ®ôÊôÇÈñì:', new Date(targetTime).toLocaleString('zh-TW'), 'isPaused:', config.isPaused);
        } else if (config.targetDate) {
          // Áõ∏ÂÆπËàäÊ†ºÂºè
          targetTime = new Date(config.targetDate).getTime();
          console.log('üéØ ÁõÆÊ®ôÊôÇÈñì (ËàäÊ†ºÂºè):', new Date(targetTime).toLocaleString('zh-TW'));
        } else {
          // È†êË®≠Ôºö3Â∞èÊôÇÂæå
          targetTime = Date.now() + (180 * 60 * 1000);
          console.log('‚ö†Ô∏è ‰ΩøÁî®È†êË®≠3Â∞èÊôÇ');
        }
      }
      
      // ÂàùÂßãÂåñË®≠ÂÆö
      loadAndApplyConfig().then(() => {
        // Êõ¥Êñ∞ÂÄíÊï∏Ë®àÊôÇÂô®
        updateCountdown();
        
        // ÂàùÂßãÂåñÂúñÁâáÈ´òÂ∫¶
        setTimeout(adjustSideImagesHeight, 100);
        
        // ÂïüÂãïÂÆöÊôÇÂô®
        startCountdownInterval();
        
        // ÂÆöÊúüÂæû‰º∫ÊúçÂô®ÂêåÊ≠•Ë®≠ÂÆöÔºàÊØè 0.5 ÁßíÊ™¢Êü•‰∏ÄÊ¨°Ôºâ
        setInterval(async () => {
          const serverConfig = await loadFromServer();
          if (serverConfig && 
              (serverConfig.targetTimestamp !== config.targetTimestamp || 
               serverConfig.isPaused !== config.isPaused ||
               serverConfig.remainingMs !== config.remainingMs)) {
            console.log('‚ö° Êî∂Âà∞‰º∫ÊúçÂô®Êé®ÈÄÅÊõ¥Êñ∞:', serverConfig);
            config = {
              ...countdownConfig,
              ...serverConfig,
              theme: countdownConfig.theme
            };
            applyConfigStyles();
            updateCountdown(); // Á´ãÂç≥Êõ¥Êñ∞È°ØÁ§∫
          }
        }, 500);
      });

      // Êõ¥Êñ∞ÂÄíÊï∏Ë®àÊôÇÂô®
      function updateCountdown() {
        // Ê™¢Êü•ÊòØÂê¶Êö´ÂÅú
        if (config.isPaused) {
          // È°ØÁ§∫Êö´ÂÅúË®äÊÅØ
          const remainingMinutes = Math.floor(config.remainingMs / 60000);
          const remainingSeconds = Math.floor((config.remainingMs % 60000) / 1000);
          
          // Ê™¢Êü•ÊòØÂê¶ÊúâÂ¢ûÂä†ÊôÇÈñìÔºåÈ°ØÁ§∫ÂãïÁï´
          if (lastRemainingMs !== null && config.remainingMs > lastRemainingMs) {
            const addedMs = config.remainingMs - lastRemainingMs;
            const addedMinutes = Math.floor(addedMs / 60000);
            const addedSeconds = Math.floor((addedMs % 60000) / 1000);
            
            // È°ØÁ§∫Âä†ÊôÇÂãïÁï´Ôºà‰ΩøÁî®ÂàÜÈêòÁÇ∫ÂñÆ‰ΩçÔºâ
            if (addedMinutes > 0) {
              showAddTimeAnimation("+" + addedMinutes, "paused-display");
            }
          }
          
          // Êõ¥Êñ∞‰∏äÊ¨°ÁöÑÂÄº
          lastRemainingMs = config.remainingMs;
          
          document.getElementById('countdownDisplay').innerHTML = 
            `<div class="end-message" style="font-size: 2rem; opacity: 0.7;" id="paused-display">
              ‚è∏Ô∏è Â∑≤Êö´ÂÅú<br>
              <span style="font-size: 1.5rem;">Ââ©È§ò ${remainingMinutes} ÂàÜ ${remainingSeconds} Áßí</span>
            </div>`;
          return;
        }

        const now = new Date().getTime();
        const distance = targetTime - now;

        if (distance < 0) {
          // ÂÄíÊï∏ÁµêÊùü
          document.getElementById('countdownDisplay').innerHTML = 
            `<div class="end-message">${config.endMessage}</div>`;
          
          if (config.onCountdownEnd) {
            config.onCountdownEnd();
          }
          
          if (config.autoReloadOnEnd) {
            setTimeout(() => location.reload(), 3000);
          }
          
          return;
        }

        // Ë®àÁÆóÊôÇÈñì
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Ê™¢Êü•ÊòØÂê¶ÊúâÂ¢ûÂä†ÔºåÈ°ØÁ§∫ÂãïÁï´
        if (lastDays !== null && days > lastDays) {
          showAddTimeAnimation("+" + (days - lastDays), "days-unit");
        }
        if (lastHours !== null && hours > lastHours) {
          showAddTimeAnimation("+" + (hours - lastHours), "hours-unit");
        }
        if (lastMinutes !== null && minutes > lastMinutes) {
          showAddTimeAnimation("+" + (minutes - lastMinutes), "minutes-unit");
        }
        if (lastSeconds !== null && seconds > lastSeconds) {
          showAddTimeAnimation("+" + (seconds - lastSeconds), "seconds-unit");
        }

        // Êõ¥Êñ∞‰∏äÊ¨°ÁöÑÂÄº
        lastDays = days;
        lastHours = hours;
        lastMinutes = minutes;
        lastSeconds = seconds;

        // Âª∫Á´ãÈ°ØÁ§∫
        let html = '';
        
        if (config.showDays && (days > 0 || config.showDays === true)) {
          html += `
            <div class="time-unit" id="days-unit">
              <div class="time-value">${days.toString().padStart(2, '0')}</div>
              <div class="time-label">Â§©</div>
            </div>
          `;
        }
        
        if (config.showHours) {
          html += `
            <div class="time-unit" id="hours-unit">
              <div class="time-value">${hours.toString().padStart(2, '0')}</div>
              <div class="time-label">ÊôÇ</div>
            </div>
          `;
        }
        
        if (config.showMinutes) {
          html += `
            <div class="time-unit" id="minutes-unit">
              <div class="time-value">${minutes.toString().padStart(2, '0')}</div>
              <div class="time-label">ÂàÜ</div>
            </div>
          `;
        }
        
        if (config.showSeconds) {
          html += `
            <div class="time-unit" id="seconds-unit">
              <div class="time-value">${seconds.toString().padStart(2, '0')}</div>
              <div class="time-label">Áßí</div>
            </div>
          `;
        }

        document.getElementById('countdownDisplay').innerHTML = html;
        
        // Ë™øÊï¥ÂÅ¥ÈÇäÂúñÁâáÈ´òÂ∫¶ËàáË®àÊôÇÂô®Ê°ÜÊ°ÜÁõ∏Âêå
        adjustSideImagesHeight();
      }

      // È°ØÁ§∫Âä†ÊôÇÈñìÂãïÁï´
      function showAddTimeAnimation(text, unitId) {
        const unitElement = document.getElementById(unitId);
        if (!unitElement) return;
        
        const valueElement = unitElement.querySelector('.time-value') || unitElement;
        if (!valueElement) return;
        
        const anim = document.createElement('span');
        anim.textContent = text;
        anim.className = 'add-time-animation';
        anim.style.left = (valueElement.offsetLeft + valueElement.offsetWidth / 2 - 20) + 'px';
        anim.style.top = (valueElement.offsetTop - 50) + 'px';
        
        document.querySelector('.countdown-display').appendChild(anim);
        
        setTimeout(() => {
          if (anim.parentNode) {
            anim.parentNode.removeChild(anim);
          }
        }, 2000);
      }

      // Ë™øÊï¥ÂÅ¥ÈÇäÂúñÁâáÈ´òÂ∫¶
      function adjustSideImagesHeight() {
        const firstTimeUnit = document.querySelector('.time-unit');
        const leftImage = document.getElementById('leftImage');
        const rightImage = document.getElementById('rightImage');
        
        if (firstTimeUnit && leftImage && rightImage) {
          const unitHeight = firstTimeUnit.offsetHeight;
          if (unitHeight > 0) {
            leftImage.style.height = unitHeight + 'px';
            rightImage.style.height = unitHeight + 'px';
          }
        }
      }

      // ÂïüÂãïÂÄíÊï∏Ë®àÊôÇÂô®
      function startCountdownInterval() {
        const interval = setInterval(() => {
          updateCountdown();
          
          // Ê™¢Êü•ÊòØÂê¶Â∑≤ÁµêÊùü
          const now = new Date().getTime();
          const distance = targetTime - now;
          if (distance < 0) {
            clearInterval(interval);
          }
        }, 1000);
      }

    </script>
  </body>
</html>
