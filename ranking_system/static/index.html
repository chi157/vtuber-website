<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è§€çœ¾æ’è¡Œæ¦œ - æŸ’æŸ’ chi</title>
    <link rel="icon" type="image/png" href="/static/images/é ­è²¼%20-%20åœ“å½¢.png" />
    <link rel="stylesheet" href="/static/style.css?v=20260213" />
    <script src="/static/navbar.js" defer></script>
    <style>
      /* æ’è¡Œæ¦œå°ˆç”¨è£œå……æ¨£å¼ */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }
      @media (max-width: 640px) {
        .stats-grid { grid-template-columns: 1fr; }
      }
      .stat-box {
        background: linear-gradient(180deg, #233a5e 0%, #2e4372 100%);
        border-radius: 18px;
        padding: 20px 16px;
        text-align: center;
        border: 1.5px solid #3a7bd5;
        box-shadow: 0 18px 40px rgba(10, 24, 51, 0.25);
        transition: transform 0.3s ease;
      }
      .stat-box:hover { transform: translateY(-4px); }
      .stat-box .icon { font-size: 1.8rem; margin-bottom: 8px; display: block; }
      .stat-box .value { font-size: 1.8rem; font-weight: 700; color: #3a7bd5; display: block; }
      .stat-box .label { font-size: 0.85rem; color: #7ea7d6; margin-top: 4px; }

      /* åˆ†é æ¨™ç±¤ */
      .ranking-tabs {
        display: flex; gap: 10px; margin-bottom: 20px;
        flex-wrap: wrap; justify-content: center;
      }
      .ranking-tab {
        background: rgba(58, 123, 213, 0.15);
        border: 1.5px solid transparent;
        color: #7ea7d6; padding: 10px 22px;
        font-size: 0.95rem; font-weight: 500;
        cursor: pointer; border-radius: 12px;
        transition: all 0.25s ease; font-family: inherit;
      }
      .ranking-tab:hover { background: rgba(58, 123, 213, 0.25); color: #eaf6ff; }
      .ranking-tab.active {
        background: #3a7bd5; border-color: #3a7bd5; color: white;
        box-shadow: 0 4px 15px rgba(58, 123, 213, 0.4);
      }

      /* æ’è¡Œæ¦œé¢æ¿ */
      .ranking-panel { display: none; }
      .ranking-panel.active { display: block; animation: fadeIn 0.3s ease; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      /* æ’è¡Œæ¦œè¡¨æ ¼ */
      .leaderboard { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .leaderboard thead { background: rgba(10, 24, 51, 0.5); }
      .leaderboard th {
        padding: 12px 14px; text-align: left;
        font-weight: 600; color: #7ea7d6;
        text-transform: uppercase; font-size: 0.72rem; letter-spacing: 0.05em;
      }
      .leaderboard td { padding: 14px; border-top: 1px solid rgba(126, 167, 214, 0.12); }
      .leaderboard tbody tr { transition: background 0.2s ease; }
      .leaderboard tbody tr:hover { background: rgba(58, 123, 213, 0.08); }
      .col-rank { width: 75px; text-align: center !important; }
      .col-score { width: 100px; text-align: right !important; }

      /* æ’åå¾½ç«  */
      .rank-badge {
        display: inline-flex; align-items: center; justify-content: center;
        width: 40px; height: 40px; border-radius: 50%;
        font-weight: 700; font-size: 1rem;
      }
      .rank-gold { background: linear-gradient(135deg, #ffd700, #ffed4a); color: #1a1a1a; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
      .rank-silver { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #1a1a1a; box-shadow: 0 0 10px rgba(192, 192, 192, 0.5); }
      .rank-bronze { background: linear-gradient(135deg, #cd7f32, #dda15e); color: #1a1a1a; box-shadow: 0 0 10px rgba(205, 127, 50, 0.5); }
      .rank-normal { background: rgba(126, 167, 214, 0.18); color: #7ea7d6; }
      .viewer-name { font-weight: 500; color: #eaf6ff; }
      .top-row .viewer-name { font-weight: 700; }
      .score-value { font-weight: 700; font-size: 1.1rem; color: #3a7bd5; }
      .score-unit { font-size: 0.85rem; color: #7ea7d6; margin-left: 4px; }
      .loading-cell, .empty-cell { text-align: center; color: #7ea7d6; padding: 40px; }

      /* æœå°‹å€ */
      .search-row { display: flex; gap: 12px; margin: 16px 0; }
      @media (max-width: 580px) { .search-row { flex-direction: column; } }
      .search-row input {
        flex: 1; padding: 12px 16px;
        border: 1.5px solid rgba(126, 167, 214, 0.25);
        border-radius: 12px; background: rgba(10, 24, 51, 0.5);
        color: #eaf6ff; font-size: 1rem; font-family: inherit;
      }
      .search-row input:focus { outline: none; border-color: #3a7bd5; }
      .search-row input::placeholder { color: #7ea7d6; }
      .search-row button {
        padding: 12px 28px; background: #3a7bd5; color: white;
        border: none; border-radius: 12px; font-size: 1rem;
        font-weight: 600; cursor: pointer; font-family: inherit;
        transition: background 0.2s ease;
      }
      .search-row button:hover { background: #2d6bc4; }

      /* ç”¨æˆ¶çµæœ */
      .user-card {
        padding: 20px; background: rgba(10, 24, 51, 0.5);
        border-radius: 12px; border: 1px solid rgba(126, 167, 214, 0.15);
        margin-top: 16px;
      }
      .user-card.hidden { display: none; }
      .user-card.error { border-color: #ff6b6b; color: #ff6b6b; }
      .user-card h4 { margin-bottom: 16px; font-size: 1.1rem; }
      .user-stats-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 12px;
      }
      .user-stat-item {
        text-align: center; padding: 12px 8px;
        background: rgba(58, 123, 213, 0.1); border-radius: 10px;
      }
      .user-stat-item .val { display: block; font-size: 1.4rem; font-weight: 700; color: #3a7bd5; }
      .user-stat-item .lbl { font-size: 0.75rem; color: #7ea7d6; margin-top: 4px; }

      /* é å°¾ */
      .ranking-footer { text-align: center; padding: 20px 0; color: #7ea7d6; font-size: 0.9rem; }
    </style>
  </head>
  <body>
    <!-- å°èˆªæ¬„å°‡ç”± navbar.js è¼‰å…¥ -->
    <div class="cloud cloud--1" aria-hidden="true"></div>
    <div class="cloud cloud--2" aria-hidden="true"></div>
    <div class="cloud cloud--3" aria-hidden="true"></div>
    <div class="cloud cloud--4" aria-hidden="true"></div>
    <main class="page">
      <section class="card">
        <section class="donate-info">
          <h2 class="donate-title">ğŸ† è§€çœ¾æ’è¡Œæ¦œ</h2>

          <!-- çµ±è¨ˆæ¦‚è¦½ -->
          <div class="stats-grid">
            <div class="stat-box">
              <span class="icon">ğŸ‘¥</span>
              <span class="value" id="totalUsers">-</span>
              <span class="label">ç¸½è§€çœ¾æ•¸</span>
            </div>
            <div class="stat-box">
              <span class="icon">ğŸ“º</span>
              <span class="value" id="totalSessions">-</span>
              <span class="label">ç¸½ç›´æ’­å ´æ•¸</span>
            </div>
            <div class="stat-box">
              <span class="icon">âœ…</span>
              <span class="value" id="totalAttendances">-</span>
              <span class="label">ç¸½å‡ºå¸­æ¬¡æ•¸</span>
            </div>
          </div>

          <!-- åˆ†é æ¨™ç±¤ -->
          <nav class="ranking-tabs">
            <button class="ranking-tab active" data-tab="streak">ğŸ”¥ é€£çºŒè§€çœ‹</button>
            <button class="ranking-tab" data-tab="total">ğŸ“Š ç´¯è¨ˆå ´æ•¸</button>
            <button class="ranking-tab" data-tab="max-streak">â­ æœ€é«˜ç´€éŒ„</button>
          </nav>

          <!-- é€£çºŒè§€çœ‹æ’è¡Œ -->
          <div id="streak-panel" class="ranking-panel active">
            <div class="info-section">
              <h3 class="section-title">ğŸ”¥ é€£çºŒè§€çœ‹å¤©æ•¸æ’è¡Œæ¦œ</h3>
              <p style="color: #7ea7d6; font-size: 0.9rem; margin-bottom: 8px;">æ¯å¤©ä¾†çœ‹ç›´æ’­ï¼Œé€£çºŒå‡ºå¸­çš„å¤©æ•¸ï¼</p>
              <table class="leaderboard">
                <thead><tr><th class="col-rank">æ’å</th><th>è§€çœ¾åç¨±</th><th class="col-score">é€£çºŒå¤©æ•¸</th></tr></thead>
                <tbody id="streakBody"><tr><td colspan="3" class="loading-cell">è¼‰å…¥ä¸­...</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- ç´¯è¨ˆå ´æ•¸æ’è¡Œ -->
          <div id="total-panel" class="ranking-panel">
            <div class="info-section">
              <h3 class="section-title">ğŸ“Š ç´¯è¨ˆè§€çœ‹å ´æ•¸æ’è¡Œæ¦œ</h3>
              <p style="color: #7ea7d6; font-size: 0.9rem; margin-bottom: 8px;">ç´¯è¨ˆåƒèˆ‡éçš„ç›´æ’­å ´æ•¸ï¼</p>
              <table class="leaderboard">
                <thead><tr><th class="col-rank">æ’å</th><th>è§€çœ¾åç¨±</th><th class="col-score">ç´¯è¨ˆå ´æ•¸</th></tr></thead>
                <tbody id="totalBody"><tr><td colspan="3" class="loading-cell">è¼‰å…¥ä¸­...</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- æœ€é«˜ç´€éŒ„æ’è¡Œ -->
          <div id="max-streak-panel" class="ranking-panel">
            <div class="info-section">
              <h3 class="section-title">â­ æœ€é«˜é€£çºŒç´€éŒ„æ’è¡Œæ¦œ</h3>
              <p style="color: #7ea7d6; font-size: 0.9rem; margin-bottom: 8px;">æ­·å²ä¸Šé”æˆéçš„æœ€é«˜é€£çºŒå¤©æ•¸ï¼</p>
              <table class="leaderboard">
                <thead><tr><th class="col-rank">æ’å</th><th>è§€çœ¾åç¨±</th><th class="col-score">æœ€é«˜ç´€éŒ„</th></tr></thead>
                <tbody id="maxStreakBody"><tr><td colspan="3" class="loading-cell">è¼‰å…¥ä¸­...</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- å€‹äººæŸ¥è©¢ -->
          <div class="info-section">
            <h3 class="section-title">ğŸ” æŸ¥è©¢å€‹äººæ’å</h3>
            <div class="search-row">
              <input type="text" id="userIdInput" placeholder="è¼¸å…¥ Twitch User ID" />
              <button id="searchBtn">æŸ¥è©¢</button>
            </div>
            <div id="userResult" class="user-card hidden"></div>
          </div>

          <!-- èªªæ˜å€ -->
          <div class="info-section highlight-box">
            <h3 class="section-title">ğŸ“‹ å¦‚ä½•åƒèˆ‡æ’è¡Œæ¦œï¼Ÿ</h3>
            <div class="rule-list">
              <div class="rule-item">
                <span class="rule-icon">ğŸ¯</span>
                <span class="rule-text"><strong>å‡ºå¸­æ¢ä»¶ï¼š</strong>åœ¨ç›´æ’­æœŸé–“æ–¼èŠå¤©å®¤ç™¼é€ä»»æ„è¨Šæ¯ï¼Œå³ç®—ç•¶å ´å‡ºå¸­</span>
              </div>
              <div class="rule-item">
                <span class="rule-icon">ğŸ”¥</span>
                <span class="rule-text"><strong>é€£çºŒå¤©æ•¸ï¼š</strong>æ¯å¤©éƒ½ä¾†çœ‹ç›´æ’­ä¸¦äº’å‹•ï¼Œé€£çºŒå¤©æ•¸å°±æœƒç´¯åŠ ï¼</span>
              </div>
              <div class="rule-item">
                <span class="rule-icon">ğŸ“Š</span>
                <span class="rule-text"><strong>ç´¯è¨ˆå ´æ•¸ï¼š</strong>æ¯åƒèˆ‡ä¸€å ´ç›´æ’­ï¼Œç´¯è¨ˆå ´æ•¸ +1</span>
              </div>
              <div class="rule-item">
                <span class="rule-icon">ğŸ’¬</span>
                <span class="rule-text"><strong>æŸ¥è©¢æŒ‡ä»¤ï¼š</strong>åœ¨èŠå¤©å®¤è¼¸å…¥ <code style="background: rgba(58, 123, 213, 0.2); padding: 2px 8px; border-radius: 6px; color: #3a7bd5;">!rank</code> æŸ¥çœ‹æ’åï¼Œ<code style="background: rgba(58, 123, 213, 0.2); padding: 2px 8px; border-radius: 6px; color: #3a7bd5;">!top</code> æŸ¥çœ‹å‰ä¸‰å</span>
              </div>
            </div>
          </div>

          <!-- CTA -->
          <div class="info-section cta-box">
            <p class="cta-text">ä¾†ç›´æ’­é–“äº’å‹•å§ï¼</p>
            <a class="btn" href="https://www.twitch.tv/chi1577517" target="_blank" rel="noopener noreferrer">
              <img class="btn-icon" src="https://cdn.jsdelivr.net/npm/simple-icons@13.1.0/icons/twitch.svg" alt="" aria-hidden="true" />
              å‰å¾€ Twitch é »é“
            </a>
            <p></p>
            <a class="btn btn-home" href="/">ğŸ  å›é¦–é </a>
          </div>

          <!-- é å°¾ -->
          <div class="ranking-footer">
            <p>æ’è¡Œæ¦œæ¯åˆ†é˜è‡ªå‹•æ›´æ–° | æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdate">-</span></p>
          </div>
        </section>
      </section>
    </main>

    <script>
      // ============================================
      // è¨­å®š
      // ============================================
      const CONFIG = {
        API_BASE_URL: '/ranking-api',
        REFRESH_INTERVAL: 60000,
        DEFAULT_LIMIT: 20
      };

      // ============================================
      // API
      // ============================================
      async function fetchAPI(endpoint) {
        try {
          const res = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } catch (e) {
          console.error(`API Error (${endpoint}):`, e);
          return null;
        }
      }

      // ============================================
      // å·¥å…·å‡½æ•¸
      // ============================================
      function formatNumber(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
        if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
        return n.toLocaleString();
      }

      function escapeHtml(t) {
        const d = document.createElement('div');
        d.textContent = t;
        return d.innerHTML;
      }

      function getRankClass(r) {
        if (r === 1) return 'rank-gold';
        if (r === 2) return 'rank-silver';
        if (r === 3) return 'rank-bronze';
        return 'rank-normal';
      }

      function createRow(data, valueKey, unit) {
        const isTop = data.rank <= 3;
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        const display = data.rank <= 3 ? medals[data.rank - 1] : data.rank;
        return `
          <tr class="${isTop ? 'top-row' : ''}">
            <td class="col-rank"><span class="rank-badge ${getRankClass(data.rank)}">${display}</span></td>
            <td><span class="viewer-name">${escapeHtml(data.username)}</span></td>
            <td class="col-score"><span class="score-value">${data[valueKey]}</span><span class="score-unit">${unit}</span></td>
          </tr>
        `;
      }

      // ============================================
      // æ›´æ–°å‡½æ•¸
      // ============================================
      async function updateStats() {
        const s = await fetchAPI('/stats');
        if (s) {
          document.getElementById('totalUsers').textContent = formatNumber(s.total_users);
          document.getElementById('totalSessions').textContent = formatNumber(s.total_sessions);
          document.getElementById('totalAttendances').textContent = formatNumber(s.total_attendances);
        }
      }

      async function updateRanking(type, bodyId, valueKey, unit) {
        const body = document.getElementById(bodyId);
        body.innerHTML = '<tr><td colspan="3" class="loading-cell">è¼‰å…¥ä¸­...</td></tr>';
        const data = await fetchAPI(`/ranking/${type}?limit=${CONFIG.DEFAULT_LIMIT}`);
        if (data === null) { body.innerHTML = '<tr><td colspan="3" class="empty-cell">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</td></tr>'; return; }
        if (data.length === 0) { body.innerHTML = '<tr><td colspan="3" class="empty-cell">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>'; return; }
        body.innerHTML = data.map(item => createRow(item, valueKey, unit)).join('');
      }

      function updateTime() {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-TW');
      }

      async function refreshAll() {
        await Promise.all([
          updateStats(),
          updateRanking('streak', 'streakBody', 'current_streak', 'å¤©'),
          updateRanking('total', 'totalBody', 'total_sessions', 'å ´'),
          updateRanking('max-streak', 'maxStreakBody', 'max_streak', 'å¤©')
        ]);
        updateTime();
      }

      // ============================================
      // åˆ†é åˆ‡æ›
      // ============================================
      function switchTab(tabName) {
        document.querySelectorAll('.ranking-tab').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
        document.querySelectorAll('.ranking-panel').forEach(panel => panel.classList.remove('active'));
        document.getElementById(`${tabName}-panel`).classList.add('active');
      }

      // ============================================
      // ç”¨æˆ¶æŸ¥è©¢
      // ============================================
      async function searchUser() {
        const input = document.getElementById('userIdInput');
        const result = document.getElementById('userResult');
        const userId = input.value.trim();

        if (!userId) {
          result.className = 'user-card error';
          result.innerHTML = 'è«‹è¼¸å…¥ Twitch User ID';
          return;
        }

        result.className = 'user-card';
        result.innerHTML = 'æŸ¥è©¢ä¸­...';

        const data = await fetchAPI(`/user/${userId}`);

        if (!data || data.error) {
          result.className = 'user-card error';
          result.innerHTML = 'æ‰¾ä¸åˆ°æ­¤ç”¨æˆ¶';
          return;
        }

        result.className = 'user-card';
        result.innerHTML = `
          <h4>ğŸ‘¤ ${escapeHtml(data.username)}</h4>
          <div class="user-stats-grid">
            <div class="user-stat-item"><span class="val">#${data.rank_streak}</span><span class="lbl">é€£çºŒæ’å</span></div>
            <div class="user-stat-item"><span class="val">${data.current_streak}</span><span class="lbl">é€£çºŒå¤©æ•¸</span></div>
            <div class="user-stat-item"><span class="val">${data.max_streak}</span><span class="lbl">æœ€é«˜ç´€éŒ„</span></div>
            <div class="user-stat-item"><span class="val">#${data.rank_total}</span><span class="lbl">ç´¯è¨ˆæ’å</span></div>
            <div class="user-stat-item"><span class="val">${data.total_sessions}</span><span class="lbl">ç´¯è¨ˆå ´æ•¸</span></div>
          </div>
        `;
      }

      // ============================================
      // åˆå§‹åŒ–
      // ============================================
      document.addEventListener('DOMContentLoaded', () => {
        refreshAll();
        document.querySelectorAll('.ranking-tab').forEach(btn => {
          btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });
        document.getElementById('searchBtn').addEventListener('click', searchUser);
        document.getElementById('userIdInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') searchUser();
        });
        setInterval(refreshAll, CONFIG.REFRESH_INTERVAL);
      });
    </script>
  </body>
</html>
